<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GeoQuest — Stable Build</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root { --bg:#0f1020; --green:#6bd451; }
body { margin:0; font-family:Outfit; background:var(--bg); color:#fff; overflow:hidden; }

#mly { position:absolute; inset:0; background:#000; }

#loader {
    position:fixed; inset:0; z-index:9999;
    display:flex; flex-direction:column;
    justify-content:center; align-items:center;
    background:#0f1020;
}
.spinner {
    width:40px; height:40px;
    border:4px solid rgba(255,255,255,.15);
    border-top-color:var(--green);
    border-radius:50%;
    animation:spin 1s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

#debug-log {
    position:fixed; top:10px; left:10px;
    z-index:10000;
    background:rgba(0,0,0,.85);
    padding:10px;
    border-radius:6px;
    font-family:monospace;
    font-size:12px;
    max-width:320px;
    white-space:pre-line;
    color:#00ff9c;
}

.app-header {
    position:fixed; top:0; left:0; width:100%; height:60px;
    background:rgba(21,21,37,.95);
    display:flex; justify-content:center; align-items:center;
    z-index:5000;
    border-bottom:1px solid rgba(255,255,255,.1);
}
.logo-text { font-weight:900; letter-spacing:2px; }

.guess-widget {
    position:absolute; bottom:20px; right:20px;
    width:320px; height:240px;
    z-index:200;
    background:#fff;
    border-radius:12px;
    overflow:hidden;
}
#guess-map { width:100%; height:100%; }
#guess-btn {
    position:absolute; bottom:15px; left:50%;
    transform:translateX(-50%);
    background:var(--green);
    color:#fff; border:none;
    padding:12px 40px;
    border-radius:50px;
    font-weight:900;
    display:none;
    cursor:pointer;
}
</style>
</head>

<body>

<div id="debug-log">Booting system…</div>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:15px; font-family:monospace; color:#888;">Loading Mapillary…</p>
</div>

<div class="app-header">
    <div class="logo-text">GEOQUEST</div>
</div>

<div id="mly"></div>

<div class="guess-widget">
    <div id="guess-map"></div>
    <button id="guess-btn">GUESS</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js"></script>

<script>
/* ================= CONFIG ================= */

const MLY_TOKEN = "MLY|25703375639353602|2d5e13e8a59dbd70a82a07650d8b497c";

/* Ultra-safe, car-covered, Mapillary-dense areas */
const TARGETS = [
  { lat: 40.7589, lng: -73.9840 },  // Times Square street grid
  { lat: 48.8572, lng: 2.2950 },    // Paris riverside roads
  { lat: 51.5033, lng: -0.1196 },   // Westminster streets
  { lat: 35.6597, lng: 139.7006 },  // Shibuya Crossing
  { lat: -33.8586, lng: 151.2140 }  // Sydney Harbour roads
];

const SEARCH_RADII = [1000, 5000, 10000]; // meters

/* ================= STATE ================= */

let viewer, guessMap, userMarker;
let roundIndex = 0;
let realLocation = null;

/* ================= UTIL ================= */

function log(msg) {
    document.getElementById("debug-log").textContent = msg;
    console.log(msg);
}

function hideLoader() {
    document.getElementById("loader").style.display = "none";
}

/* ================= MAPS ================= */

function initGuessMap() {
    guessMap = L.map("guess-map", { zoomControl:false }).setView([20,0], 2);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png")
        .addTo(guessMap);

    guessMap.on("click", e => {
        if (userMarker) guessMap.removeLayer(userMarker);
        userMarker = L.marker(e.latlng).addTo(guessMap);
        document.getElementById("guess-btn").style.display = "block";
    });
}

/* ================= MAPILLARY ================= */

function initViewer() {
    viewer = new mapillary.Viewer({
        accessToken: MLY_TOKEN,
        container: "mly",
        component: { cover:false, attribution:false }
    });
}

/* ================= SEARCH ================= */

async function searchImage(lat, lng) {
    for (let r of SEARCH_RADII) {
        log(`Searching ${r/1000} km radius…`);

        const delta = r / 111000;
        const bbox = [
            lng - delta,
            lat - delta,
            lng + delta,
            lat + delta
        ].join(",");

        const url =
          `https://graph.mapillary.com/images?access_token=${MLY_TOKEN}` +
          `&fields=id,geometry&bbox=${bbox}&limit=1`;

        try {
            const res = await fetch(url);
            const json = await res.json();

            if (json.data && json.data.length) {
                const img = json.data[0];
                realLocation = {
                    lat: img.geometry.coordinates[1],
                    lng: img.geometry.coordinates[0]
                };
                log("Image found ✔ Loading viewer…");
                await viewer.moveToKey(img.id);
                hideLoader();
                return true;
            }
        } catch (e) {
            log("Fetch error, retrying wider…");
        }
    }
    return false;
}

/* ================= GAME ================= */

async function loadRound() {
    document.getElementById("guess-btn").style.display = "none";
    if (userMarker) guessMap.removeLayer(userMarker);
    userMarker = null;

    if (roundIndex >= TARGETS.length) {
        hideLoader();
        log("All rounds completed.");
        return;
    }

    const target = TARGETS[roundIndex];
    log(`Round ${roundIndex+1} → ${target.lat}, ${target.lng}`);

    const found = await searchImage(target.lat, target.lng);

    if (!found) {
        log("No image found. Skipping target…");
        roundIndex++;
        loadRound();
    }
}

/* ================= START ================= */

window.onload = async () => {
    initGuessMap();
    initViewer();
    await loadRound();
};
</script>

</body>
</html>
